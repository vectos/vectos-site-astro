import { j as createVNode, s as spreadAttributes, F as Fragment } from './astro.360f122a.mjs';
import 'cookie';
import 'kleur/colors';
import 'slash';
import 'path-to-regexp';
import 'mime';
import 'html-escaper';
import 'string-width';

const images = {
					
				};

				function updateImageReferences(html) {
					return html.replaceAll(
						/__ASTRO_IMAGE_="(.+)"/gm,
						(full, imagePath) => spreadAttributes({src: images[imagePath].src, ...images[imagePath].attributes})
					);
				}

				const html = updateImageReferences("<h2 id=\"motivation\">Motivation</h2>\n<p>A common architectural style is the 3 layer model (data, service, and API/view layer) for writing web services. With this style, the data layer is tested with unit tests, H2 database or not. The service layer is tested with mocks, where the calls to the database are emulated.</p>\n<p>The approach with the data layer has some downsides. Like inserting, updating, and reading things can be seen as encoding/decoding data from a medium. As you might like encoding and decoding JSON, decoding might go wrong. When working with databases, schema changes might cause decode errors when you do not update your domain model. Or when you introduce a new enum member it might that the database cannot store this yet. To assert that we have symmetric encoding and decoding effects, we can use property-based tests. Also if you use Postgres and H2 for testing, there might be discrepancies like H2 doesn’t have PostGIS or other unsupported features.</p>\n<p>The approach with the service layer has some downsides, What if the behavior of the repository method changes over time or the emulated repository method is invalid? You’ll test with the wrong assumptions and you might introduce bugs.</p>\n<h2 id=\"a-solution\">A solution</h2>\n<p>To tackle both pitfalls we can use oracles and model-based testing which are according to <a href=\"https://fsharpforfunandprofit.com/posts/property-based-testing-2/#model-based-testing\">F# for fun and profit</a>:</p>\n<blockquote>\n<p>The way it works is that, in parallel with your (complex) system under test, you create a simplified model. Then, when you do something to the system under test, you do the same (but simplified) thing to your model. In the end, you compare your model’s state with the state of the system under test. If they are the same, you’re done.</p>\n</blockquote>\n<p>In our case, we use a mirror implementation of the interface. When working with the data layer, we have a real database implementation and an in-memory implementation. The in-memory implementation can be used as an <em>oracle</em>. The oracle can also be used in <em>both</em> testing the data and service layer. In the data layer tests, the oracle is used to verify that the in-memory variant mirrors the behavior of the database and in the service layer tests we use the oracle to mock the database.</p>\n<p>In this case, we work with a functional scala tech stack: Doobie and ZIO. We use ZIO mainly in the upper layers like the service layer and API layer to handle side effects.</p>\n<h2 id=\"the-data-layer\">The data layer</h2>\n<h3 id=\"coding-a-repository-interface\">Coding a repository interface</h3>\n<p>When coding a repository in Scala you can choose to commit to an effect type like <code>cats.effect.IO</code>, <code>scala.concurrent.Future</code> or <code>zio.Task</code> from the start. However, this also has downsides.</p>\n<ul>\n<li>What if you would like to compose several methods?</li>\n<li>In testing evaluating the effect of an effect type like <code>zio.Task</code> has an immediate effect leaving a dirty database that can interfere with other tests</li>\n</ul>\n<p>When you use doobie you could use <code>ConnectionIO</code> or if you use slick <code>DBIO</code> to implement these repositories in terms of the effect type which is transactional and can be rolled back. This means you can compose multiple repository methods like inserting and reading an entity while rolling back the whole operation, leaving the database clean while you have tested the behavior.</p>\n<p>A repository interface could look like this:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">final</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">id</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">UUID</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">name</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">trait</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PersonRepository</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[_]] {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">insertMany</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">persons</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">deleteWhenOlderThen</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">listAll</span><span style=\"color: #24292F\">()</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">]]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PersonRepository</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">implicit</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> functorK</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">FunctorK</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">PersonRepository</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Derive</span><span style=\"color: #24292F\">.functorK</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">implicit</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> semigroupalK</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">SemigroupalK</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">PersonRepository</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Derive</span><span style=\"color: #24292F\">.semigroupalK</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>We use <code>FunctorK</code> and <code>SemigroupalK</code> here, which are explained on the <a href=\"https://typelevel.org/cats-tagless/\">cats-tagless documentation</a>. In essence, they give you functions that allow you to transform the interface in interesting ways. Like with <code>FunctorK</code> we can transform the effect type and with <code>SemigroupalK</code> we can execute two interpreters at the same time which is needed for our data layer testing.</p>\n<h3 id=\"coding-a-repository-database-implementation\">Coding a repository database implementation</h3>\n<p>When it comes to coding a doobie implementation it is pretty straightforward. We implement <code>PersonRepository</code> in terms of <code>ConnectionIO</code>.</p>\n<p>One thing to note is that we separate out the queries from the interface. By doing this we can test queries later with the doobie-specs2 package which allows you to test the syntax of queries.</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">DoobiePersonRepository</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">extends</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">PersonRepository</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">ConnectionIO</span><span style=\"color: #24292F\">] {</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">queries</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">deleteWhenOlderThen</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Update0</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">fr</span><span style=\"color: #0A3069\">\"delete from persons where age > </span><span style=\"color: #24292F\">$age</span><span style=\"color: #0A3069\">\"</span><span style=\"color: #24292F\">.update</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">listAll</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Query0</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">fr</span><span style=\"color: #0A3069\">\"select id, name, age from persons\"</span><span style=\"color: #24292F\">.query[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">insertMany</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">persons</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ConnectionIO</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Update</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">](</span><span style=\"color: #0A3069\">\"insert into persons (id, name, age) values (?, ?, ?)\"</span><span style=\"color: #24292F\">).updateMany(persons).map(_.toLong)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">deleteWhenOlderThen</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ConnectionIO</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    queries.deleteWhenOlderThen(age).run.map(_.toLong)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">listAll</span><span style=\"color: #24292F\">()</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ConnectionIO</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">]] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    queries.listAll.to[</span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<h3 id=\"coding-a-repository-in-memory-implementation\">Coding a repository in-memory implementation</h3>\n<p>To code an in-memory implementation we would like to emulate a database and its operations. How you could do that?</p>\n<ul>\n<li>A database can be emulated by using a case class that has fields and where each field is a table in the database. Each field should be a <code>List[A]</code>. If every field is a <code>List[A]</code> you could potentially derive a <code>Monoid</code> for free.</li>\n<li>We need a common set of combinators that allow you to query and mutate.</li>\n</ul>\n<p>The first part is simple, we could for example create a case class that will hold our state of the database like this.</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">persons</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">])</span></span></code></pre>\n<p>Now to query or mutate we need to emulate the behavior of transaction as well, but also when we want to query the database we need to have access to the whole <code>Universe</code>.</p>\n<p>In functional programming luckily we have the <code>State</code> monad which is perfect for this. If the repository is implemented in terms of <code>State[Universe, *]</code> we can chain together multiple mutations to form a transaction as well if a query is weaved inside the transaction it will work, because the internal state is updated.</p>\n<p>To write universal combinators we need setters to mutate the <code>Universe</code> structure and getters to query the <code>Universe</code> structure. In functional programming, we also have an abstraction for this: lenses. In this case, I’ll use the excellent library Monocle. When you annotate your <code>Universe</code> case class with the <code>@Lenses</code> annotation, Monocle will automatically generate lenses on the companion object of <code>Universe</code>. In this case, we will have a lens defined <code>Universe.persons</code> which is of type <code>Lens[Universe, List[Person]]</code>.</p>\n<p>Now with all the ingredients we can start writing our first combinators:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">final</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">private</span><span style=\"color: #24292F\"> (</span><span style=\"color: #953800\">db</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">State</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">run</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">state</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> db.runA(state).value</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">all</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">at</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Lens</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">State</span><span style=\"color: #24292F\">.get.map(at.get))</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">insertMany</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">at</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Lens</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]])(</span><span style=\"color: #953800\">elements</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    insertMany_(at)(elements).size</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">insertMany_</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">at</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Lens</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]])(</span><span style=\"color: #953800\">elements</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">State</span><span style=\"color: #24292F\">.modify[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">](s </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> at.modify(_ </span><span style=\"color: #CF222E\">++</span><span style=\"color: #24292F\"> elements)(s)) </span><span style=\"color: #CF222E\">*></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">State</span><span style=\"color: #24292F\">.pure(elements))</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">insert</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">at</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Lens</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]])(</span><span style=\"color: #953800\">element</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    insertMany(at)(</span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">(element))</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">delete</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">at</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Lens</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]])(</span><span style=\"color: #953800\">filter</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Boolean</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    delete_(at)(filter).size</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">delete_</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">at</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Lens</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]])(</span><span style=\"color: #953800\">filter</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Boolean</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">for</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        elements </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">State</span><span style=\"color: #24292F\">.get[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        (toDelete, toKeep) </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> at.get(elements).partition(filter)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">State</span><span style=\"color: #24292F\">.modify[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">](s </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> at.modify(_ </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> toKeep)(s))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      } </span><span style=\"color: #CF222E\">yield</span><span style=\"color: #24292F\"> toDelete</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>The first thing to note is that we create a new type (in Scala 3 we could use opaque types) called <code>Septic</code> wrapping a <code>State</code> monad which has constrained combinators. The nice thing about these general combinators is:</p>\n<ul>\n<li>They infer the <code>Septic</code> type when you supply it the <code>Lens[D, List[A]]</code></li>\n<li>When used with an atomic reference, you could even use the implementation to a bootup server and use it locally for testing for example</li>\n</ul>\n<p>With these combinators we can code our <code>PersonRepository</code>:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">@</span><span style=\"color: #953800\">Lenses</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">final</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">(</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #953800\">persons</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">zero</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">Nil</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">SepticPersonRepository</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">extends</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">PersonRepository</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">, </span><span style=\"color: #CF222E\">*</span><span style=\"color: #24292F\">]] {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">insertMany</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">persons</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">.insertMany(</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">.persons)(persons)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">deleteWhenOlderThen</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Long</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">.delete(</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">.persons)(_.age </span><span style=\"color: #CF222E\">></span><span style=\"color: #24292F\"> age)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">listAll</span><span style=\"color: #24292F\">()</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">]] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">.all(</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">.persons)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<h3 id=\"testing-our-in-memory-and-data-layer-implementation\">Testing our in-memory and data layer implementation</h3>\n<p>As stated before, if we want to assert that our data layer is right we need to run for example a database program (like an insert and read) in parallel. This is where <code>SemigroupalK</code> comes into play.</p>\n<p>In my proof of concept library I’ve created a <code>Harnass</code>:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Harnass</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Alg</span><span style=\"color: #24292F\">[_[_]], </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[_], </span><span style=\"color: #953800\">Tx</span><span style=\"color: #24292F\">[_], </span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">initState</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">db</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Alg</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Tx</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">model</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Alg</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #CF222E\">*</span><span style=\"color: #24292F\">]], </span><span style=\"color: #953800\">tx</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Tx</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #6E7781\">// create a effect type which is higher kinded tuple which has the doobie version and Septic version</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">type</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Eff</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Tuple2K</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Tx</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Septic</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">D</span><span style=\"color: #24292F\">, </span><span style=\"color: #CF222E\">*</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #6E7781\">// set the effect type of the repository interface </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">type</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Paired</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Alg</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Eff</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #6E7781\">// a eval function which uses the Paired and returns a `F[(A,A)]`</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">trait</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Evaluator</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">eval</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">f</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Paired</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Eff</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[(</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">)]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">model</span><span style=\"color: #24292F\">(</span><span style=\"color: #CF222E\">implicit</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">S</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">SemigroupalK</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Alg</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">F</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Functor</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Evaluator</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> paired</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Paired</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">S</span><span style=\"color: #24292F\">.productK(db, model)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">new</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Evaluator</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">override</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">eval</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">f</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Paired</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Eff</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[(</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">)] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #6E7781\">//here we get the `Tuple2K` from `f`</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> effectTuple</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Eff</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> f(paired)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #6E7781\">//we run the connection against a rollback transactor, and get the result</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> dbValue</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> tx(effectTuple.first)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #6E7781\">//we run the state monad and get the value</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> stateValue</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> effectTuple.second.run(initState)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">        dbValue.map(_ </span><span style=\"color: #CF222E\">-></span><span style=\"color: #24292F\"> stateValue)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>Don’t be daunted by the generic parameters. I’ll go quickly over them:</p>\n<ul>\n<li><code>Alg</code> is the repository type <code>PersonRepository</code> in our case</li>\n<li><code>F</code> is the effect type like <code>cats.effect.IO</code></li>\n<li><code>Tx</code> is the transaction type, this is <code>ConnectionIO</code> from Doobie</li>\n<li><code>D</code> is the state type used for <code>Septic</code>, in our case, this is <code>Universe</code></li>\n</ul>\n<p>Like stated before, it creates out of <code>SemigroupalK[Alg]</code> a higher kinded paired version. So for we combine two interpreters of <code>PersonRepository</code> like: <code>PersonRepository[ConnnectionIO]</code> and <code>PersonRepository[Septic[Universe, *]]</code> into a <code>PersonRepository[Tuple2K[ConnectionIO, Septic[Universe, *], *]]</code>.</p>\n<p>A few tests in my proof of concept look like this:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">harnass</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Harnass</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">PersonRepository</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">IO</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">ConnectionIO</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">new</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Harnass</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">Universe</span><span style=\"color: #24292F\">.zero, </span><span style=\"color: #953800\">DoobiePersonRepository</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">SepticPersonRepository</span><span style=\"color: #24292F\">, xa.trans)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #0A3069\">\"PersonRepository\"</span><span style=\"color: #24292F\"> should {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #0A3069\">\"should insert and read\"</span><span style=\"color: #24292F\"> in {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      prop { </span><span style=\"color: #953800\">persons</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        assertMirroring {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          harnass.model.eval { x </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">              x.insertMany(persons) </span><span style=\"color: #CF222E\">*></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">              x.listAll()</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #0A3069\">\"should delete people older then\"</span><span style=\"color: #24292F\"> in {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      prop { (</span><span style=\"color: #953800\">persons</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">List</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Person</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        assertMirroring {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          harnass.model.eval { x </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">              x.insertMany(persons) </span><span style=\"color: #CF222E\">*></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">              x.deleteWhenOlderThen(age) </span><span style=\"color: #CF222E\">*></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">              x.listAll()</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span></code></pre>\n<p>In this case, we use specs2 with scalacheck to do property-based testing. We ask scalacheck to generate arbitrary lists of <code>Person</code> instances and run our database program by using <code>harnass.model.eval</code>. This is wrapped by <code>assertMirroring</code> is a little helper method that asserts that the values in the returned tuple are equal.</p>\n<p>The <code>*></code> can be read as followed. Alternatively you could also write a for comprehension if that is easier on you. Another nice thing to note is that we can configure the <code>Transactor[IO]</code> to be a rollback transactor by setting <code>always</code> on the strategy to <code>connection.rollback *> connection.close</code></p>\n<h3 id=\"using-the-oracle-in-service-layer-tests\">Using the oracle in service layer tests</h3>\n<p>As stated before we use ZIO for our service layer. When writing flows you can just put them on objects for example like this:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PersonService</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">deletePersonsOlderThen</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">RIO</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Pg</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Unit</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">for</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ZIO</span><span style=\"color: #24292F\">.when(age </span><span style=\"color: #CF222E\">&#x3C;</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">0</span><span style=\"color: #24292F\">)(</span><span style=\"color: #953800\">ZIO</span><span style=\"color: #24292F\">.fail(</span><span style=\"color: #953800\">AppError</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">InvalidAge</span><span style=\"color: #24292F\">))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Pg</span><span style=\"color: #24292F\">.query(_.persons.deleteWhenOlderThen(age))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    } </span><span style=\"color: #CF222E\">yield</span><span style=\"color: #24292F\"> ()</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>The nice thing about doing this is that you don’t have problems with circular dependencies as the dependencies are residing in the <code>RIO</code> effect type offered by ZIO as you can read <a href=\"https://zio.dev/docs/datatypes/contextual/\">here</a>.</p>\n<p>I don’t like to assert invariants in the API layer, as it’s harder to test and the API layer its concern is to decode incoming requests and encode responses. In this case, the invariant is that the age should be greater than zero. When it’s smaller we use <code>ZIO.fail</code> to stop the program and exit with the <code>AppError.InvalidAge</code>. After that, we use the data layer by using the <code>Pg</code> service.</p>\n<p>In this case, we require the <code>Pg</code> service which I like to define like this:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">trait</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PostgresRepos</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">[_]] {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">persons</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PersonRepository</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">F</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PostgresRepos</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">implicit</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> functorK</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">FunctorK</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">PostgresRepos</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Derive</span><span style=\"color: #24292F\">.functorK</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Pg</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">trait</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Service</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #6E7781\">// This is `ConnectionIO` in production.</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">type</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ConnIO</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #6E7781\">// Collection of all the `ConnectionIO` based repositories</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">protected</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> postgresReposConnIO</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PostgresRepos</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">ConnIO</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #6E7781\">// The natural transformation which transforms `ConnectionIO` to a `Task`</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">protected</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> transTask</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ConnIO</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Task</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">lazy</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> postgresReposTask</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">PostgresRepos</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      postgresReposConnIO.mapK(transTask)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">query</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">f</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">PostgresRepos</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      f(postgresReposTask)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">query</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">f</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">PostgresRepos</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">])</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Eff</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Pg</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">ZIO</span><span style=\"color: #24292F\">.accessM(_.get.query(f).mapError(err </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">AppError</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">Unexpected</span><span style=\"color: #24292F\">(err)))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>The query accessor method has access to <code>PostgresRepos</code> which is a trait that is a collection of all the repositories.</p>\n<p>Now comes the trick. When you use it in production, you’ll use the <code>DoobieXXX</code> version and when you <em>unit test</em> your service methods, you use the <code>SepticXXX</code> versions which are asserted to be equal to the <code>DoobieXXX</code> versions.</p>\n<h2 id=\"conclusion\">Conclusion</h2>\n<p>I hope this article gave you insight into how to test your data layer and have better service layer tests as well.</p>\n<p>By using the oracle we solve a few problems</p>\n<ul>\n<li>In the data layer tests we test with the real database without making the database dirty by using rollback on each <code>ConnectionIO</code></li>\n<li>We assert encoding/decoding symmetry from our domain model. You might miss out on decoding existing entries in the database though.</li>\n<li>In the service layer tests we don’t use mocks, but in-memory variants which mirror the behavior of the real implementation asserted in the data layer tests</li>\n</ul>\n<p>I’ve actually coded the <code>Septic</code> thing into a repository and you can find it up <a href=\"https://github.com/vectos/septic/\">here</a>. It’s a proof of concept, but I’ve used this methodology at DHL Netherlands. It needs some work on testing all the combinators at <code>Septic</code>. If someone wants to continue the work actually release this to Maven Central go ahead. It would be great to mention my work if you do.</p>");

				const frontmatter = {"pubDate":"2021-08-09","banner":"/img/blog/test-oracle.png","title":"Using oracles to test the service and data layer","description":"Getting rid of mocks in your service layer tests and test your database for real"};
				const file = "/Users/mark/Projects/Personal/markdejong.org/src/content/blog/oracle-testing.md";
				const url = undefined;
				function rawContent() {
					return "\n## Motivation\n\nA common architectural style is the 3 layer model (data, service, and API/view layer) for writing web services. With this style, the data layer is tested with unit tests, H2 database or not. The service layer is tested with mocks, where the calls to the database are emulated.\n\nThe approach with the data layer has some downsides. Like inserting, updating, and reading things can be seen as encoding/decoding data from a medium. As you might like encoding and decoding JSON, decoding might go wrong. When working with databases, schema changes might cause decode errors when you do not update your domain model. Or when you introduce a new enum member it might that the database cannot store this yet. To assert that we have symmetric encoding and decoding effects, we can use property-based tests. Also if you use Postgres and H2 for testing, there might be discrepancies like H2 doesn't have PostGIS or other unsupported features.\n\nThe approach with the service layer has some downsides, What if the behavior of the repository method changes over time or the emulated repository method is invalid? You'll test with the wrong assumptions and you might introduce bugs.\n\n## A solution\n\nTo tackle both pitfalls we can use oracles and model-based testing which are according to [F# for fun and profit](https://fsharpforfunandprofit.com/posts/property-based-testing-2/#model-based-testing):\n\n> The way it works is that, in parallel with your (complex) system under test, you create a simplified model. Then, when you do something to the system under test, you do the same (but simplified) thing to your model. In the end, you compare your model’s state with the state of the system under test. If they are the same, you’re done.\n\nIn our case, we use a mirror implementation of the interface. When working with the data layer, we have a real database implementation and an in-memory implementation. The in-memory implementation can be used as an _oracle_. The oracle can also be used in _both_ testing the data and service layer. In the data layer tests, the oracle is used to verify that the in-memory variant mirrors the behavior of the database and in the service layer tests we use the oracle to mock the database. \n\nIn this case, we work with a functional scala tech stack: Doobie and ZIO. We use ZIO mainly in the upper layers like the service layer and API layer to handle side effects.\n\n## The data layer\n\n### Coding a repository interface\n\nWhen coding a repository in Scala you can choose to commit to an effect type like `cats.effect.IO`, `scala.concurrent.Future` or `zio.Task` from the start. However, this also has downsides.\n\n- What if you would like to compose several methods?\n- In testing evaluating the effect of an effect type like `zio.Task` has an immediate effect leaving a dirty database that can interfere with other tests\n\nWhen you use doobie you could use `ConnectionIO` or if you use slick `DBIO` to implement these repositories in terms of the effect type which is transactional and can be rolled back. This means you can compose multiple repository methods like inserting and reading an entity while rolling back the whole operation, leaving the database clean while you have tested the behavior.\n\nA repository interface could look like this:\n\n```scala\nfinal case class Person(id: UUID, name: String, age: Int)\n\ntrait PersonRepository[F[_]] {\n  def insertMany(persons: List[Person]): F[Long]\n  def deleteWhenOlderThen(age: Long): F[Long]\n  def listAll(): F[List[Person]]\n}\n\n\nobject PersonRepository {\n  implicit val functorK: FunctorK[PersonRepository] = Derive.functorK\n  implicit val semigroupalK: SemigroupalK[PersonRepository] = Derive.semigroupalK\n}\n```\n\nWe use `FunctorK` and `SemigroupalK` here, which are explained on the [cats-tagless documentation](https://typelevel.org/cats-tagless/). In essence, they give you functions that allow you to transform the interface in interesting ways. Like with `FunctorK` we can transform the effect type and with `SemigroupalK` we can execute two interpreters at the same time which is needed for our data layer testing.\n\n### Coding a repository database implementation\n\nWhen it comes to coding a doobie implementation it is pretty straightforward. We implement `PersonRepository` in terms of `ConnectionIO`.\n\nOne thing to note is that we separate out the queries from the interface. By doing this we can test queries later with the doobie-specs2 package which allows you to test the syntax of queries.\n\n```scala\nobject DoobiePersonRepository extends PersonRepository[ConnectionIO] {\n\n  object queries {\n    def deleteWhenOlderThen(age: Long): Update0 =\n      fr\"delete from persons where age > $age\".update\n\n    def listAll: Query0[Person] =\n      fr\"select id, name, age from persons\".query[Person]\n  }\n\n  def insertMany(persons: List[Person]): ConnectionIO[Long] =\n    Update[Person](\"insert into persons (id, name, age) values (?, ?, ?)\").updateMany(persons).map(_.toLong)\n\n  def deleteWhenOlderThen(age: Long): ConnectionIO[Long] =\n    queries.deleteWhenOlderThen(age).run.map(_.toLong)\n\n  def listAll(): ConnectionIO[List[Person]] =\n    queries.listAll.to[List]\n}\n```\n\n### Coding a repository in-memory implementation\n\nTo code an in-memory implementation we would like to emulate a database and its operations. How you could do that?\n\n- A database can be emulated by using a case class that has fields and where each field is a table in the database. Each field should be a `List[A]`. If every field is a `List[A]` you could potentially derive a `Monoid` for free. \n- We need a common set of combinators that allow you to query and mutate.\n\nThe first part is simple, we could for example create a case class that will hold our state of the database like this. \n\n```scala\ncase class Universe(persons: List[Person])\n```\n\nNow to query or mutate we need to emulate the behavior of transaction as well, but also when we want to query the database we need to have access to the whole `Universe`.\n\nIn functional programming luckily we have the `State` monad which is perfect for this. If the repository is implemented in terms of `State[Universe, *]` we can chain together multiple mutations to form a transaction as well if a query is weaved inside the transaction it will work, because the internal state is updated.\n\nTo write universal combinators we need setters to mutate the `Universe` structure and getters to query the `Universe` structure. In functional programming, we also have an abstraction for this: lenses. In this case, I'll use the excellent library Monocle. When you annotate your `Universe` case class with the `@Lenses` annotation, Monocle will automatically generate lenses on the companion object of `Universe`. In this case, we will have a lens defined `Universe.persons` which is of type `Lens[Universe, List[Person]]`.\n\nNow with all the ingredients we can start writing our first combinators:\n\n```scala\nfinal case class Septic[D, A] private (db: State[D, A]) {\n  def run(state: D): A = db.runA(state).value\n}\n\nobject Septic {\n  def all[D, A](at: Lens[D, List[A]]): Septic[D, List[A]] =\n    Septic(State.get.map(at.get))\n\n  def insertMany[D, A](at: Lens[D, List[A]])(elements: List[A]): Septic[D, Long] =\n    insertMany_(at)(elements).size\n\n  def insertMany_[D, A](at: Lens[D, List[A]])(elements: List[A]): Septic[D, List[A]] =\n    Septic(State.modify[D](s => at.modify(_ ++ elements)(s)) *> State.pure(elements))\n\n  def insert[D, A](at: Lens[D, List[A]])(element: A): Septic[D, Long] =\n    insertMany(at)(List(element))\n\n  def delete[D, A](at: Lens[D, List[A]])(filter: A => Boolean): Septic[D, Long] =\n    delete_(at)(filter).size\n\n  def delete_[D, A](at: Lens[D, List[A]])(filter: A => Boolean): Septic[D, List[A]] =\n    Septic {\n      for {\n        elements <- State.get[D]\n        (toDelete, toKeep) = at.get(elements).partition(filter)\n        _ <- State.modify[D](s => at.modify(_ => toKeep)(s))\n      } yield toDelete\n    }\n}\n```\n\nThe first thing to note is that we create a new type (in Scala 3 we could use opaque types) called `Septic` wrapping a `State` monad which has constrained combinators. The nice thing about these general combinators is:\n\n- They infer the `Septic` type when you supply it the `Lens[D, List[A]]`\n- When used with an atomic reference, you could even use the implementation to a bootup server and use it locally for testing for example\n\nWith these combinators we can code our `PersonRepository`:\n\n```scala\n@Lenses\nfinal case class Universe(\n  persons: List[Person]\n)\n\nobject Universe {\n  def zero: Universe = Universe(Nil)\n}\n\nobject SepticPersonRepository extends PersonRepository[Septic[Universe, *]] {\n  def insertMany(persons: List[Person]): Septic[Universe, Long] =\n    Septic.insertMany(Universe.persons)(persons)\n\n  def deleteWhenOlderThen(age: Long): Septic[Universe, Long] =\n    Septic.delete(Universe.persons)(_.age > age)\n\n  def listAll(): Septic[Universe, List[Person]] =\n    Septic.all(Universe.persons)\n}\n```\n\n### Testing our in-memory and data layer implementation\n\nAs stated before, if we want to assert that our data layer is right we need to run for example a database program (like an insert and read) in parallel. This is where `SemigroupalK` comes into play.\n\nIn my proof of concept library I've created a `Harnass`:\n\n```scala\nclass Harnass[Alg[_[_]], F[_], Tx[_], D](initState: D, db: Alg[Tx], model: Alg[Septic[D, *]], tx: Tx ~> F) {\n  \n  // create a effect type which is higher kinded tuple which has the doobie version and Septic version\n  type Eff[A] = Tuple2K[Tx, Septic[D, *], A]\n  // set the effect type of the repository interface \n  type Paired = Alg[Eff]\n\n  // a eval function which uses the Paired and returns a `F[(A,A)]`\n  trait Evaluator {\n    def eval[A](f: Paired => Eff[A]): F[(A, A)]\n  }\n\n  def model(implicit S: SemigroupalK[Alg], F: Functor[F]): Evaluator = {\n    val paired: Paired = S.productK(db, model)\n    new Evaluator {\n      override def eval[A](f: Paired => Eff[A]): F[(A, A)] = {\n        //here we get the `Tuple2K` from `f`\n        val effectTuple: Eff[A] = f(paired)\n        //we run the connection against a rollback transactor, and get the result\n        val dbValue: F[A] = tx(effectTuple.first)\n        //we run the state monad and get the value\n        val stateValue: A = effectTuple.second.run(initState)\n\n        dbValue.map(_ -> stateValue)\n      }\n    }\n  }\n}\n```\n\nDon't be daunted by the generic parameters. I'll go quickly over them:\n\n- `Alg` is the repository type `PersonRepository` in our case\n- `F` is the effect type like `cats.effect.IO`\n- `Tx` is the transaction type, this is `ConnectionIO` from Doobie\n- `D` is the state type used for `Septic`, in our case, this is `Universe`\n\nLike stated before, it creates out of `SemigroupalK[Alg]` a higher kinded paired version. So for we combine two interpreters of `PersonRepository` like: `PersonRepository[ConnnectionIO]` and `PersonRepository[Septic[Universe, *]]` into a `PersonRepository[Tuple2K[ConnectionIO, Septic[Universe, *], *]]`.\n\nA few tests in my proof of concept look like this:\n\n```scala\n  def harnass: Harnass[PersonRepository, IO, ConnectionIO, Universe] =\n    new Harnass(Universe.zero, DoobiePersonRepository, SepticPersonRepository, xa.trans)\n\n  \"PersonRepository\" should {\n    \"should insert and read\" in {\n      prop { persons: List[Person] =>\n        assertMirroring {\n          harnass.model.eval { x =>\n              x.insertMany(persons) *>\n              x.listAll()\n          }\n        }\n      }\n    }\n\n    \"should delete people older then\" in {\n      prop { (persons: List[Person], age: Int) =>\n        assertMirroring {\n          harnass.model.eval { x =>\n              x.insertMany(persons) *>\n              x.deleteWhenOlderThen(age) *>\n              x.listAll()\n          }\n        }\n      }\n    }\n  }\n```\n\nIn this case, we use specs2 with scalacheck to do property-based testing. We ask scalacheck to generate arbitrary lists of `Person` instances and run our database program by using `harnass.model.eval`. This is wrapped by `assertMirroring` is a little helper method that asserts that the values in the returned tuple are equal.\n\nThe `*>` can be read as followed. Alternatively you could also write a for comprehension if that is easier on you. Another nice thing to note is that we can configure the `Transactor[IO]` to be a rollback transactor by setting `always` on the strategy to `connection.rollback *> connection.close`\n\n### Using the oracle in service layer tests\n\nAs stated before we use ZIO for our service layer. When writing flows you can just put them on objects for example like this:\n\n```scala\n\nobject PersonService {\n  def deletePersonsOlderThen(age: Int): RIO[Pg, Unit] =\n    for {\n      _ <- ZIO.when(age < 0)(ZIO.fail(AppError.InvalidAge))\n      _ <- Pg.query(_.persons.deleteWhenOlderThen(age))\n    } yield ()\n}\n```\n\nThe nice thing about doing this is that you don't have problems with circular dependencies as the dependencies are residing in the `RIO` effect type offered by ZIO as you can read [here](https://zio.dev/docs/datatypes/contextual/).\n\nI don't like to assert invariants in the API layer, as it's harder to test and the API layer its concern is to decode incoming requests and encode responses. In this case, the invariant is that the age should be greater than zero. When it's smaller we use `ZIO.fail` to stop the program and exit with the `AppError.InvalidAge`. After that, we use the data layer by using the `Pg` service.\n\nIn this case, we require the `Pg` service which I like to define like this:\n\n```scala\ntrait PostgresRepos[F[_]] {\n  def persons: PersonRepository[F]\n}\n\nobject PostgresRepos {\n  implicit val functorK: FunctorK[PostgresRepos] = Derive.functorK\n}\n\nobject Pg {\n\n  trait Service {\n    // This is `ConnectionIO` in production.\n    type ConnIO[A]\n\n    // Collection of all the `ConnectionIO` based repositories\n    protected val postgresReposConnIO: PostgresRepos[ConnIO]\n\n    // The natural transformation which transforms `ConnectionIO` to a `Task`\n    protected val transTask: ConnIO ~> Task\n\n    lazy val postgresReposTask: PostgresRepos[Task] =\n      postgresReposConnIO.mapK(transTask)\n\n    def query[A](f: PostgresRepos[Task] => Task[A]): Task[A] =\n      f(postgresReposTask)\n  }\n\n  def query[A](f: PostgresRepos[Task] => Task[A]): Eff[Pg, A] =\n    ZIO.accessM(_.get.query(f).mapError(err => AppError.Unexpected(err)))\n}\n```\n\nThe query accessor method has access to `PostgresRepos` which is a trait that is a collection of all the repositories.\n\nNow comes the trick. When you use it in production, you'll use the `DoobieXXX` version and when you _unit test_ your service methods, you use the `SepticXXX` versions which are asserted to be equal to the `DoobieXXX` versions.\n\n## Conclusion\n\nI hope this article gave you insight into how to test your data layer and have better service layer tests as well.\n\nBy using the oracle we solve a few problems\n\n- In the data layer tests we test with the real database without making the database dirty by using rollback on each `ConnectionIO`\n- We assert encoding/decoding symmetry from our domain model. You might miss out on decoding existing entries in the database though.\n- In the service layer tests we don't use mocks, but in-memory variants which mirror the behavior of the real implementation asserted in the data layer tests\n\nI've actually coded the `Septic` thing into a repository and you can find it up [here](https://github.com/vectos/septic/). It's a proof of concept, but I've used this methodology at DHL Netherlands. It needs some work on testing all the combinators at `Septic`. If someone wants to continue the work actually release this to Maven Central go ahead. It would be great to mention my work if you do.\n";
				}
				function compiledContent() {
					return html;
				}
				function getHeadings() {
					return [{"depth":2,"slug":"motivation","text":"Motivation"},{"depth":2,"slug":"a-solution","text":"A solution"},{"depth":2,"slug":"the-data-layer","text":"The data layer"},{"depth":3,"slug":"coding-a-repository-interface","text":"Coding a repository interface"},{"depth":3,"slug":"coding-a-repository-database-implementation","text":"Coding a repository database implementation"},{"depth":3,"slug":"coding-a-repository-in-memory-implementation","text":"Coding a repository in-memory implementation"},{"depth":3,"slug":"testing-our-in-memory-and-data-layer-implementation","text":"Testing our in-memory and data layer implementation"},{"depth":3,"slug":"using-the-oracle-in-service-layer-tests","text":"Using the oracle in service layer tests"},{"depth":2,"slug":"conclusion","text":"Conclusion"}];
				}
				async function Content() {
					const { layout, ...content } = frontmatter;
					content.file = file;
					content.url = url;
					const contentFragment = createVNode(Fragment, { 'set:html': html });
					return contentFragment;
				}
				Content[Symbol.for('astro.needsHeadRendering')] = true;

export { Content, compiledContent, Content as default, file, frontmatter, getHeadings, images, rawContent, url };
