import { j as createVNode, s as spreadAttributes, F as Fragment } from './astro.360f122a.mjs';
import 'cookie';
import 'kleur/colors';
import 'slash';
import 'path-to-regexp';
import 'mime';
import 'html-escaper';
import 'string-width';

const images = {
					
				};

				function updateImageReferences(html) {
					return html.replaceAll(
						/__ASTRO_IMAGE_="(.+)"/gm,
						(full, imagePath) => spreadAttributes({src: images[imagePath].src, ...images[imagePath].attributes})
					);
				}

				const html = updateImageReferences("<p>In The Netherlands, we have a good train network. However, from time to time the Nederlandse Spoorwegen (NS - the guys who run the trains) have disruptions. I want to have notifications, so I can just check my phone when waking up and see if there is any trouble.</p>\n<p>To check out the source, please check ns-tracker</p>\n<h2 id=\"knowledge-prerequisites\">Knowledge prerequisites</h2>\n<p>Before continue reading this article you should have an understanding of:</p>\n<ul>\n<li>API’s and formats like XML &#x26; JSON</li>\n<li>Advanced Scala (implicits, type classes, generics, etc)</li>\n<li>Functional concepts like Monads &#x26; Monad Transformers</li>\n</ul>\n<h2 id=\"the-stack\">The stack</h2>\n<p>I’ve used the following libraries:</p>\n<ul>\n<li>Cats - Functional Programming constructs (like Monad, Monad Transformers, etc)</li>\n<li>Postgres - For storing state in the database</li>\n<li>Doobie - For JDBC database</li>\n<li>Circe - JSON encoding and decoding</li>\n<li>fs2 - Pull based stream processing. Offers also Task, an alternative to Future</li>\n<li>Atto - For parsing Telegram commands</li>\n</ul>\n<h2 id=\"telegram\">Telegram</h2>\n<p>With Telegram, you will be able to create bots. This is something which WhatsApp doesn’t offer. What does it mean to develop a Telegram bot?</p>\n<ul>\n<li>You can start talking to a bot and Telegram will buffer the messages</li>\n<li>Telegram will act as a mediator. Any messages posted to a bot go through Telegram. You as bot developer have to either long poll for updates or set up a webhook</li>\n<li>Each command is processed by your logic. That means you are responsible for persisting state and handling the commands</li>\n<li>For creating a basic bot you need to retrieve the messages which are posted in the bot and respond</li>\n<li>You can send a user a message any time</li>\n</ul>\n<h3 id=\"creating-a-bot-and-get-your-botid\">Creating a bot and get your botId</h3>\n<p>You can create a bot by talking to the BotFather. By entering /newbot you’ll get a botId which is needed in the API calls</p>\n<h3 id=\"register-your-server\">Register your server</h3>\n<p>You can either use long polling or webhooks to retrieve messages posted to a Telegram bot. I’ll explain how I did setup webhooks.</p>\n<p>You have to POST <a href=\"https://api.telegram.org/bot%7BbotId%7D/setWebhook\">https://api.telegram.org/bot{botId}/setWebhook</a> with a form-urlencoded body which contains url={url_to_your_message_handler_endpoint}.</p>\n<p>Whenever a user posts a message to your Telegram bot now, Telegram will post it to url_to_your_message_handler_endpoint.</p>\n<p>A message may look like this:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #24292F\">{</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #116329\">\"update_id\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0550AE\">169800632</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #116329\">\"message\"</span><span style=\"color: #24292F\">: {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #116329\">\"message_id\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0550AE\">646</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #116329\">\"from\"</span><span style=\"color: #24292F\">: {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">            </span><span style=\"color: #116329\">\"id\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0550AE\">348940006</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">            </span><span style=\"color: #116329\">\"first_name\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0A3069\">\"Mark\"</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">            </span><span style=\"color: #116329\">\"last_name\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0A3069\">\"de Jong\"</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        },</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #116329\">\"chat\"</span><span style=\"color: #24292F\">: {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">            </span><span style=\"color: #116329\">\"id\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0550AE\">348940006</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">            </span><span style=\"color: #116329\">\"first_name\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0A3069\">\"Mark\"</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">            </span><span style=\"color: #116329\">\"last_name\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0A3069\">\"de Jong\"</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">            </span><span style=\"color: #116329\">\"type\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0A3069\">\"private\"</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        },</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #116329\">\"date\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0550AE\">1494929704</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #116329\">\"text\"</span><span style=\"color: #24292F\">: </span><span style=\"color: #0A3069\">\"test\"</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<h3 id=\"send-a-message-back\">Send a message back</h3>\n<p>Now you want to send back a message. You can use this endpoint to send a message back:</p>\n<p><code>POST https://api.telegram.org/bot{botId}/sendMessage</code> with also a <code>form-urlencoded</code> body contains these variables:</p>\n<ul>\n<li>chat_id - The id of the chat</li>\n<li>text - The actual message</li>\n</ul>\n<p>It will return you a JSON with the message you posted\nNederlandse Spoorwegen data</p>\n<p>To retrieve data from the Nederlandse Spoorwegen (NS), we can talk to their API. To be specific we can use the endpoint <code>GET https://webservices.ns.nl/ns-api-avt?station=Zwolle</code> to retrieve all voyages which depart from that station. You’ll need to use basic HTTP authentication to retrieve data from this endpoint.</p>\n<p>The data is formatted in XML and looks like this:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #24292F\">&#x3C;</span><span style=\"color: #116329\">ActueleVertrekTijden</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  &#x3C;</span><span style=\"color: #116329\">VertrekkendeTrein</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">RitNummer</span><span style=\"color: #24292F\">>535&#x3C;/</span><span style=\"color: #116329\">RitNummer</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">VertrekTijd</span><span style=\"color: #24292F\">>2017-05-16T11:45:00+0200&#x3C;/</span><span style=\"color: #116329\">VertrekTijd</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">VertrekVertraging</span><span style=\"color: #24292F\">>PT2M&#x3C;/</span><span style=\"color: #116329\">VertrekVertraging</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">VertrekVertragingTekst</span><span style=\"color: #24292F\">>+2 min&#x3C;/</span><span style=\"color: #116329\">VertrekVertragingTekst</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">EindBestemming</span><span style=\"color: #24292F\">>Groningen&#x3C;/</span><span style=\"color: #116329\">EindBestemming</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">TreinSoort</span><span style=\"color: #24292F\">>Intercity&#x3C;/</span><span style=\"color: #116329\">TreinSoort</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">RouteTekst</span><span style=\"color: #24292F\">>Assen&#x3C;/</span><span style=\"color: #116329\">RouteTekst</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">Vervoerder</span><span style=\"color: #24292F\">>NS&#x3C;/</span><span style=\"color: #116329\">Vervoerder</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    &#x3C;</span><span style=\"color: #116329\">VertrekSpoor</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">wijziging</span><span style=\"color: #24292F\">=</span><span style=\"color: #0A3069\">\"true\"</span><span style=\"color: #24292F\">>6&#x3C;/</span><span style=\"color: #116329\">VertrekSpoor</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  &#x3C;/</span><span style=\"color: #116329\">VertrekkendeTrein</span><span style=\"color: #24292F\">></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">&#x3C;/</span><span style=\"color: #116329\">ActueleVertrekTijden</span><span style=\"color: #24292F\">></span></span></code></pre>\n<p>There is information like at which time the train departs, at which stations it will stop it, if there is any delay, etc.</p>\n<h2 id=\"high-level-architecture\">High-level architecture</h2>\n<p>The program contains two processes</p>\n<ul>\n<li>An interval based loop which retrieves a set of unique stations that have a watch. For each station, it will contact the NS API. Whenever there is a disruption it will use the Telegram sendMessage API to notify the user. When this succeeds it will store that the user is notified in the database. This process will recur over time by an interval</li>\n<li>An HTTP server which is used to listen webhooks (called by Telegram)</li>\n</ul>\n<p>In functional programming, we tend to keep our logic centered and push all the side-effects to the boundary of our application. There are numerous examples in functional programming for that: free monads, fs2, etc.</p>\n<p>One of the components of our program is the Telegram command to reply pipeline. From a webhook, we extract the message (command) and pass it into a pipeline which translates the command to actual reply (with side effects). Let’s dive into how to create such a pipeline.</p>\n<p>It would be a bad design to couple in the HttpRequest (from webhooks) or HttpResponse (from long polling) into the pipeline. The message is just a String and we need to act accordingly. By decoupling this, we could plug this pipeline either with long polling or webhooks.</p>\n<h2 id=\"telegram-command-to-reply-pipeline\">Telegram command to reply pipeline</h2>\n<p>So for each command, we need to:</p>\n<ul>\n<li>Parse the actual command into a case class</li>\n<li>Use the case class to do stuff with the database (query, insert or remove a watch)</li>\n<li>Respond to the user</li>\n</ul>\n<p>It’s a good practice to define the small steps required to achieve your end goal. Now let’s solve all the requirements step by step.</p>\n<h3 id=\"parsing\">Parsing</h3>\n<p>How do we parse the Telegram messages? We could use a regular expression, but it would be better to use actual parsers. Rob Norris wrote a little and comprehensive parsing library called Atto.</p>\n<p>For this bot I made it possible to track, remove and list your watches by these commands:</p>\n<ul>\n<li>track “from-station” “to-station” from-time till-time - Add a watch for voyage track for any disruptions. Note that and should be surrounded by double-quotes. With time, note that and should be in a 24h format (00:00)</li>\n<li>remove id - Remove a watch by id</li>\n<li>list - List all watches and their id (to remove it)</li>\n</ul>\n<p>Let’s first define our commands:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">sealed</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">trait</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">BotCommand</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">BotCommand</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">TrackVoyage</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">fromStation</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">toStation</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">fromHour</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Time</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">toHour</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Time</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">extends</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">BotCommand</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">RemoveVoyage</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">id</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">extends</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">BotCommand</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ListVoyages</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">extends</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">BotCommand</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>Parsing this with Atto is quite simple:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">object</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Parsing</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">private</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">fixed</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">n</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Parser</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    count(n, digit).map(_.mkString).flatMap { s </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">try</span><span style=\"color: #24292F\"> ok(s.toInt) </span><span style=\"color: #CF222E\">catch</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">e</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">NumberFormatException</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> err(e.toString)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">private</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> time </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> (fixed(</span><span style=\"color: #0550AE\">2</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">&#x3C;~</span><span style=\"color: #24292F\"> char(</span><span style=\"color: #0550AE\">':'</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">|@|</span><span style=\"color: #24292F\"> fixed(</span><span style=\"color: #0550AE\">2</span><span style=\"color: #24292F\">)) map </span><span style=\"color: #953800\">Time</span><span style=\"color: #24292F\">.apply</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">private</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> station </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> stringLiteral</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> trackVoyage</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Parser</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">BotCommand</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">TrackVoyage</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    (string(</span><span style=\"color: #0A3069\">\"track\"</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> (spaceChar </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> station) </span><span style=\"color: #CF222E\">|@|</span><span style=\"color: #24292F\"> (spaceChar </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> station) </span><span style=\"color: #CF222E\">|@|</span><span style=\"color: #24292F\"> (spaceChar </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> time) </span><span style=\"color: #CF222E\">|@|</span><span style=\"color: #24292F\"> (spaceChar </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> time)) map </span><span style=\"color: #953800\">BotCommand</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">TrackVoyage</span><span style=\"color: #24292F\">.apply</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> removeVoyage</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Parser</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">BotCommand</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">RemoveVoyage</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    (string(</span><span style=\"color: #0A3069\">\"remove\"</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> (spaceChar </span><span style=\"color: #CF222E\">~></span><span style=\"color: #24292F\"> int)) map </span><span style=\"color: #953800\">BotCommand</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">RemoveVoyage</span><span style=\"color: #24292F\">.apply</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> listVoyages</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Parser</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">BotCommand</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">ListVoyages</span><span style=\"color: #24292F\">.</span><span style=\"color: #CF222E\">type</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    string(</span><span style=\"color: #0A3069\">\"list\"</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">>|</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">BotCommand</span><span style=\"color: #24292F\">.</span><span style=\"color: #953800\">ListVoyages</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<h3 id=\"creating-handlers\">Creating handlers</h3>\n<p>Now we got the parsers we need to create handlers for each command. So what is needed for a command handler?</p>\n<ul>\n<li>We need a parser which extracts the actual command as a case class (we’ve used coded that as a Parser[A])</li>\n<li>There is a choice between multiple handlers. Whenever the parsing succeeds it should continue with the supplied function (which has the extracted command and performs database queries) and when it fails to parse, it should try the next handler</li>\n<li>We have branching in our command handling. The entered command might a good one, or one which will fail. We need to verify that by using assertions or database queries. In the end, the format of the result will be the same (A user expects a message what his command did)</li>\n</ul>\n<h4 id=\"partial-functions\">Partial functions</h4>\n<p>So let’s start with the choice between multiple handlers. We can model that with a PartialFunction. The nice thing about PartialFunction is that they are composable. You can combine multiple PartialFunction’s by using <code>orElse</code> You can create a partial function by using Function.unlift. The signature looks like: <code>def unlift[T, R](f: T => Option[R]): PartialFunction[T, R]</code> which is in the standard Scala library.</p>\n<p>So a quick a example:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> a </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Function</span><span style=\"color: #24292F\">.unlift[</span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">](str </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">if</span><span style=\"color: #24292F\">(str </span><span style=\"color: #CF222E\">==</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">\"1\"</span><span style=\"color: #24292F\">) </span><span style=\"color: #953800\">Some</span><span style=\"color: #24292F\">(</span><span style=\"color: #0550AE\">1</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">else</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">None</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> b </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Function</span><span style=\"color: #24292F\">.unlift[</span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">](str </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">if</span><span style=\"color: #24292F\">(str </span><span style=\"color: #CF222E\">==</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">\"2\"</span><span style=\"color: #24292F\">) </span><span style=\"color: #953800\">Some</span><span style=\"color: #24292F\">(</span><span style=\"color: #0550AE\">2</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">else</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">None</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> c </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> a orElse b</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">process</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">i</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> c.applyOrElse(i, (</span><span style=\"color: #953800\">_</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">0</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">process(</span><span style=\"color: #0A3069\">\"1\"</span><span style=\"color: #24292F\">) </span><span style=\"color: #6E7781\">// will return 1</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">process(</span><span style=\"color: #0A3069\">\"3\"</span><span style=\"color: #24292F\">) </span><span style=\"color: #6E7781\">// will return 0</span></span></code></pre>\n<p>This is, of course, a simple example, but it will work with our little <code>Parser[A]</code>. We can feed that a String using parseOnly which will return a <code>ParseResult[A]</code> which is convertible to an <code>Option[A]</code>. That’s exactly what we need for PartialFunction!\nBranching and running database effects</p>\n<p>So now we get to the part where we need to branch our computations and run database effects. As stated before we are using Doobie for the database. Running a query will return us a <code>Task[A]</code> and requires us to have a <code>transactor.Transactor[Task]</code> to turn <code>Query[A]</code> into <code>Task[Vector[A]]</code> for example.</p>\n<p>To have <code>transactor.Transactor[Task]</code> available, we can use a type <code>Prg[A] = ReaderT[F, transactor.Transactor[Task], A]]</code> for this matter. Where <code>F[_]</code> is a <code>Monad</code>. You don’t need to pass this <code>transactor.Transactor[Task]</code> around when writing a handler, we push this concern to the boundary of our app.</p>\n<p>Whenever a query returns not enough results or the entered information is incorrect we need to return an error or continue whenever everything is alright. In other words, branching. We can use <code>Either[L, R]</code> to do branching (which is right biased in Scala 2.12 and forms a Monad). However, we need to evaluate the effects of <code>Task[_]</code> (<code>Task[_]</code> is also a Monad). So we’ll need a <code>type Prg[A] = EitherT[Task, String, A]</code> (monad transformer). This also forms a <code>Monad</code>, so we can put this into the <code>F[_]</code> of <code>type Prg[A] = ReaderT[F, transactor.Transactor[Task], A]</code>.</p>\n<p>This will give us a <code>type Prg[A] => ReaderT[EitherT[Task, String, ?], transactor.Transactor[Task], A]]</code>. What is this <code>?</code> syntax. It is syntax sugar for type lambdas. You can find more info on that on the kind-projector project.</p>\n<p>To actual lift expressions <code>Option[A]</code>, <code>Query[A]</code> or <code>Task[A]</code> to this monad transformer stack I create several combinators that ease the process. I’ve left those out in this article, but you may see them in the final example. In case you are curious, you could check the source code to see their implementation.</p>\n<h2 id=\"putting-it-together\">Putting it together</h2>\n<p>So how do we put this together? The handle combinator would look something like this:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">handle</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">](</span><span style=\"color: #953800\">p</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Parser</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\">])(</span><span style=\"color: #953800\">f</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">A</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ReaderT</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">EitherT</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">, </span><span style=\"color: #CF222E\">?</span><span style=\"color: #24292F\">], transactor.</span><span style=\"color: #953800\">Transactor</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">]]) </span><span style=\"color: #CF222E\">=</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #953800\">Function</span><span style=\"color: #24292F\">.unlift[</span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">ReaderT</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">, transactor.</span><span style=\"color: #953800\">Transactor</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">]](x </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      p.parseOnly(x).map(y </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> f(x).mapF(_.fold(identity, identity))).option</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    )</span></span></code></pre>\n<p>So let’s break this down. The arguments are</p>\n<ul>\n<li><code>p: Parser[A]</code> is required to extract <code>A</code> from a <code>String</code></li>\n<li><code>f: A => ReaderT[EitherT[Task, String, ?], transactor.Transactor[Task], String]]</code> is the actual handler function. It returns the monad stack as composed before and it consumes the parsed <code>A</code></li>\n</ul>\n<p>In the implementation of the handler combinator, <code>Function.unlift</code> will consume String and return a <code>ReaderT[Task, transactor.Transactor[Task], String]</code>. First we use the parse the string using <code>p.parseOnly(x)</code>. This will return a <code>ParseResult[A]</code> which has a map combinator. After that we apply our f function to get a <code>ReaderT[EitherT[Task, String, ?], transactor.Transactor[Task], String]]</code>. After that we use <code>mapF</code> to remove the disjunction part (<code>EitherT</code>) by <code>_.fold(identity, identity)</code>. After that we use the <code>.option</code> combinator to turn <code>ParseResult[ReaderT[Task, transactor.Transactor[Task], String]]</code> into a <code>Option[ReaderT[Task, transactor.Transactor[Task], String]]</code>. Remember that we need to return a <code>Option</code> for <code>Function.unlift</code>. So that concludes the implementation of the handle combinator. Below a example of the usage of handle:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> add </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> handle(</span><span style=\"color: #953800\">Parsing</span><span style=\"color: #24292F\">.trackVoyage) { req </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">for</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> guard(</span><span style=\"color: #953800\">Stations</span><span style=\"color: #24292F\">.names.contains(req.fromStation), </span><span style=\"color: #CF222E\">s</span><span style=\"color: #0A3069\">\"Station '</span><span style=\"color: #24292F\">${req.fromStation}</span><span style=\"color: #0A3069\">' not found\"</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> guard(</span><span style=\"color: #953800\">Stations</span><span style=\"color: #24292F\">.names.contains(req.toStation), </span><span style=\"color: #CF222E\">s</span><span style=\"color: #0A3069\">\"Station '</span><span style=\"color: #24292F\">${req.toStation}</span><span style=\"color: #0A3069\">' not found\"</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> update(</span><span style=\"color: #953800\">VoyageSubscription</span><span style=\"color: #24292F\">(req.fromStation, req.toStation, req.fromHour, req.toHour))(</span><span style=\"color: #953800\">Queries</span><span style=\"color: #24292F\">.insertSubscription)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  } </span><span style=\"color: #CF222E\">yield</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">\"Added\"</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> remove </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> handle(</span><span style=\"color: #953800\">Parsing</span><span style=\"color: #24292F\">.removeVoyage) { req </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">for</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    count </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> update0(</span><span style=\"color: #953800\">Queries</span><span style=\"color: #24292F\">.removeSubscription(req.id, req.chatId))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> guard(count </span><span style=\"color: #CF222E\">></span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">0</span><span style=\"color: #24292F\">, </span><span style=\"color: #CF222E\">s</span><span style=\"color: #0A3069\">\"Failed to removed voyage with id </span><span style=\"color: #24292F\">${req.id}</span><span style=\"color: #0A3069\">\"</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  } </span><span style=\"color: #CF222E\">yield</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">\"Removed\"</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> list </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> handle(</span><span style=\"color: #953800\">Parsing</span><span style=\"color: #24292F\">.listVoyages) { req </span><span style=\"color: #CF222E\">=></span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">for</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    voyages </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> listQuery(</span><span style=\"color: #953800\">Queries</span><span style=\"color: #24292F\">.listSubscriptions(req.chatId))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  } </span><span style=\"color: #CF222E\">yield</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">if</span><span style=\"color: #24292F\"> (voyages.nonEmpty) </span><span style=\"color: #953800\">BotReply</span><span style=\"color: #24292F\">(voyages.map(v </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">s</span><span style=\"color: #0A3069\">\"</span><span style=\"color: #24292F\">${v.id}</span><span style=\"color: #0A3069\"> | </span><span style=\"color: #24292F\">${v.value.fromStation}</span><span style=\"color: #0A3069\"> ->> </span><span style=\"color: #24292F\">${v.value.toStation}</span><span style=\"color: #0A3069\">\"</span><span style=\"color: #24292F\">).mkString(</span><span style=\"color: #0A3069\">\"</span><span style=\"color: #0550AE\">\\n</span><span style=\"color: #0A3069\">\"</span><span style=\"color: #24292F\">))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">else</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">\"You don't have any voyages yet!\"</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> handlers </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> add orElse remove orElse list</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">handleRequest</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">xa</span><span style=\"color: #24292F\">: transactor.</span><span style=\"color: #953800\">Transactor</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">])</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">                 (</span><span style=\"color: #953800\">r</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> fail </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> (</span><span style=\"color: #953800\">_</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ReaderT</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">, transactor.</span><span style=\"color: #953800\">Transactor</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">String</span><span style=\"color: #24292F\">](_ </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">.now(</span><span style=\"color: #0A3069\">\"Invalid command\"</span><span style=\"color: #24292F\">))</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  handlers.applyOrElse(r, fail).run(xa)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>As you can see, it’s very concise to define handlers. Like I said before I’ve defined monad transformer combinators like <code>guard</code>, <code>update</code>, <code>update0</code>, <code>listQuery</code>, etc for validating, retrieving and update/inserting data (you can see their implementation at the repository).</p>\n<p>So to recap, how did we design this pipeline?</p>\n<ul>\n<li>We split up our problems in small steps</li>\n<li>For each step, we evaluate which solutions we could apply (by experimenting or consulting our functional programming tools)</li>\n<li>We model our side-effects and branching explicitly</li>\n<li>We push side-effects to the boundary of the program</li>\n</ul>\n<h1 id=\"stream-processing-with-fs2\">Stream processing with fs2</h1>\n<p>As stated before we have two processes in our program. One for handling HTTP requests and one for pulling the database from time to time and check if there any disruptions for the interested watchers. I’ll show and explain the latter.</p>\n<p>This is the code for pulling the database and notify the watcher in case of disruption:</p>\n<pre is:raw=\"\" class=\"astro-code\" style=\"background-color: #ffffff; overflow-x: auto;\"><code><span class=\"line\"><span style=\"color: #6E7781\">//a `Task[_]` which sends a telegram message and stores that we've notified the user in the database</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">def</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">notify</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">sub</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Entity</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">VoyageSubscription</span><span style=\"color: #24292F\">], </span><span style=\"color: #953800\">delayedVoyage</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">Voyage</span><span style=\"color: #24292F\">)</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Int</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">???</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">val</span><span style=\"color: #24292F\"> notifier</span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Stream</span><span style=\"color: #24292F\">[</span><span style=\"color: #953800\">Task</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">Unit</span><span style=\"color: #24292F\">] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">for</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> fs2.time.awakeEvery(</span><span style=\"color: #0550AE\">60</span><span style=\"color: #24292F\">.seconds)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  voyageSubscription </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Queries</span><span style=\"color: #24292F\">.uniqueSubscribedStations.process.transact(xa)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  voyages </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Stream</span><span style=\"color: #24292F\">.eval(</span><span style=\"color: #953800\">NsApi</span><span style=\"color: #24292F\">.voyages(voyageSubscription.fromStation).run(cfg.ns))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  delayedVoyage </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Stream</span><span style=\"color: #24292F\">.emits(voyages.filter(x </span><span style=\"color: #CF222E\">=></span><span style=\"color: #24292F\"> x.delay.nonEmpty </span><span style=\"color: #CF222E\">||</span><span style=\"color: #24292F\"> x.comments.exists(_.contains(</span><span style=\"color: #0A3069\">\"Rijdt niet\"</span><span style=\"color: #24292F\">))))</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  sub </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Queries</span><span style=\"color: #24292F\">.subscriptions(voyageSubscription.subscriptionIds, delayedVoyage.ritNr).process.transact(xa)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  _ </span><span style=\"color: #CF222E\">&#x3C;-</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">if</span><span style=\"color: #24292F\">(delayedVoyage.destinations.contains(sub.value.toStation)) </span><span style=\"color: #953800\">Stream</span><span style=\"color: #24292F\">.eval(notify(sub, delayedVoyage)) </span><span style=\"color: #CF222E\">else</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Stream</span><span style=\"color: #24292F\">.emit(())</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">} </span><span style=\"color: #CF222E\">yield</span><span style=\"color: #24292F\"> ()</span></span></code></pre>\n<p>We can build up a Stream[F, A] by using a for-comprehension. This is because Stream is also a Monad.</p>\n<ul>\n<li><code>_ &#x3C;- fs2.time.awakeEvery(60.seconds)</code> - will sleep the stream for 60 seconds</li>\n<li><code>voyageSubscription &#x3C;- Queries.uniqueSubscribedStations.process.transact(xa)</code> - Will retrieve all stations which are been watched by the users. <code>.process</code> will turn this <code>Query[VoyageSubscriptions]</code> into <code>Stream[Task, VoyageSubscriptions]</code></li>\n<li><code>voyages &#x3C;- Stream.eval(NsApi.voyages(voyageSubscription.fromStation).run(cfg.ns))</code> - Will call the NS API and retrieve a <code>List[Voyage]</code>. The combinator <code>Stream.eval</code> will evaluate a <code>Task[A]</code> and put it into the <code>Stream[Task, A]</code></li>\n<li><code>delayedVoyage &#x3C;- Stream.emits(voyages.filter(x => x.delay.nonEmpty || x.comments.exists(_.contains(\"Rijdt niet\"))))</code> - Will only filter delayed voyages. After that we use Stream.emits to emit a <code>Seq[A]</code> to a <code>Stream[Task, A]</code></li>\n<li><code>sub &#x3C;- Queries.subscriptions(voyageSubscription.subscriptionIds, delayedVoyage.ritNr).process.transact(xa)</code> - Will retrieve a list of watches which are not notified yet. Note that we use <code>.process</code> again to retrieve a query as a <code>Stream[Task, A]</code>.</li>\n<li><code>_ &#x3C;- if(delayedVoyage.destinations.contains(sub.value.toStation)) Stream.eval(notify(sub, delayedVoyage)) else Stream.emit(())</code> - Will check if <code>delayedVoyage.destinations</code> contains the target station of the watcher. If so, we’ll notify otherwise we just continue.</li>\n</ul>\n<p>As you can see it’s very easily building a pull-based stream processor by using fs2 and doobie.</p>\n<h1 id=\"conclusion-and-future-work\">Conclusion and future work</h1>\n<p>I liked writing code in the functional style in Scala. We explicitly capture side effects, push the effects to the outside of the program, pull-based stream processing, easy configuration, and excellent JSON encoding/decoding. The quality of these functional libraries is excellent.</p>\n<p>The work on this bot is not complete. It needs circuit breakers, setting up a watch can be conversational, etc.</p>");

				const frontmatter = {"pubDate":"2017-05-16","banner":"/img/blog/banner_telegram.png","title":"Developing a Telegram bot by applying Functional Scala","description":" In this article, I'll explain how I build a Telegram bot by applying Functional Scala. Libraries used are FS2, Circe, Doobie, and Atto"};
				const file = "/Users/mark/Projects/Personal/markdejong.org/src/content/blog/telegram-bot-in-functional-scala.md";
				const url = undefined;
				function rawContent() {
					return "\nIn The Netherlands, we have a good train network. However, from time to time the Nederlandse Spoorwegen (NS - the guys who run the trains) have disruptions. I want to have notifications, so I can just check my phone when waking up and see if there is any trouble.\n\nTo check out the source, please check ns-tracker\n\n## Knowledge prerequisites\n\nBefore continue reading this article you should have an understanding of:\n\n- API’s and formats like XML & JSON\n- Advanced Scala (implicits, type classes, generics, etc)\n- Functional concepts like Monads & Monad Transformers\n\n## The stack\n\nI’ve used the following libraries:\n\n- Cats - Functional Programming constructs (like Monad, Monad Transformers, etc)\n- Postgres - For storing state in the database\n- Doobie - For JDBC database\n- Circe - JSON encoding and decoding\n- fs2 - Pull based stream processing. Offers also Task, an alternative to Future\n- Atto - For parsing Telegram commands\n\n## Telegram\n\nWith Telegram, you will be able to create bots. This is something which WhatsApp doesn’t offer. What does it mean to develop a Telegram bot?\n\n- You can start talking to a bot and Telegram will buffer the messages\n- Telegram will act as a mediator. Any messages posted to a bot go through Telegram. You as bot developer have to either long poll for updates or set up a webhook\n- Each command is processed by your logic. That means you are responsible for persisting state and handling the commands\n- For creating a basic bot you need to retrieve the messages which are posted in the bot and respond\n- You can send a user a message any time\n\n### Creating a bot and get your botId\n\nYou can create a bot by talking to the BotFather. By entering /newbot you’ll get a botId which is needed in the API calls\n\n### Register your server\n\nYou can either use long polling or webhooks to retrieve messages posted to a Telegram bot. I’ll explain how I did setup webhooks.\n\nYou have to POST https://api.telegram.org/bot{botId}/setWebhook with a form-urlencoded body which contains url={url_to_your_message_handler_endpoint}.\n\nWhenever a user posts a message to your Telegram bot now, Telegram will post it to url_to_your_message_handler_endpoint.\n\nA message may look like this:\n\n```json lineNumbers\n{\n    \"update_id\": 169800632,\n    \"message\": {\n        \"message_id\": 646,\n        \"from\": {\n            \"id\": 348940006,\n            \"first_name\": \"Mark\",\n            \"last_name\": \"de Jong\"\n        },\n        \"chat\": {\n            \"id\": 348940006,\n            \"first_name\": \"Mark\",\n            \"last_name\": \"de Jong\",\n            \"type\": \"private\"\n        },\n        \"date\": 1494929704,\n        \"text\": \"test\"\n    }\n}\n```\n\n### Send a message back\n\nNow you want to send back a message. You can use this endpoint to send a message back:\n\n`POST https://api.telegram.org/bot{botId}/sendMessage` with also a `form-urlencoded` body contains these variables:\n\n- chat_id - The id of the chat\n- text - The actual message\n\nIt will return you a JSON with the message you posted\nNederlandse Spoorwegen data\n\nTo retrieve data from the Nederlandse Spoorwegen (NS), we can talk to their API. To be specific we can use the endpoint `GET https://webservices.ns.nl/ns-api-avt?station=Zwolle` to retrieve all voyages which depart from that station. You’ll need to use basic HTTP authentication to retrieve data from this endpoint.\n\nThe data is formatted in XML and looks like this:\n\n```xml\n<ActueleVertrekTijden>\n  <VertrekkendeTrein>\n    <RitNummer>535</RitNummer>\n    <VertrekTijd>2017-05-16T11:45:00+0200</VertrekTijd>\n    <VertrekVertraging>PT2M</VertrekVertraging>\n    <VertrekVertragingTekst>+2 min</VertrekVertragingTekst>\n    <EindBestemming>Groningen</EindBestemming>\n    <TreinSoort>Intercity</TreinSoort>\n    <RouteTekst>Assen</RouteTekst>\n    <Vervoerder>NS</Vervoerder>\n    <VertrekSpoor wijziging=\"true\">6</VertrekSpoor>\n  </VertrekkendeTrein>\n</ActueleVertrekTijden>\n```\n\nThere is information like at which time the train departs, at which stations it will stop it, if there is any delay, etc.\n\n## High-level architecture\n\nThe program contains two processes\n\n- An interval based loop which retrieves a set of unique stations that have a watch. For each station, it will contact the NS API. Whenever there is a disruption it will use the Telegram sendMessage API to notify the user. When this succeeds it will store that the user is notified in the database. This process will recur over time by an interval\n- An HTTP server which is used to listen webhooks (called by Telegram)\n\nIn functional programming, we tend to keep our logic centered and push all the side-effects to the boundary of our application. There are numerous examples in functional programming for that: free monads, fs2, etc.\n\nOne of the components of our program is the Telegram command to reply pipeline. From a webhook, we extract the message (command) and pass it into a pipeline which translates the command to actual reply (with side effects). Let’s dive into how to create such a pipeline.\n\nIt would be a bad design to couple in the HttpRequest (from webhooks) or HttpResponse (from long polling) into the pipeline. The message is just a String and we need to act accordingly. By decoupling this, we could plug this pipeline either with long polling or webhooks.\n\n## Telegram command to reply pipeline\n\nSo for each command, we need to:\n\n- Parse the actual command into a case class\n- Use the case class to do stuff with the database (query, insert or remove a watch)\n- Respond to the user\n\nIt’s a good practice to define the small steps required to achieve your end goal. Now let’s solve all the requirements step by step.\n\n\n### Parsing\n\nHow do we parse the Telegram messages? We could use a regular expression, but it would be better to use actual parsers. Rob Norris wrote a little and comprehensive parsing library called Atto.\n\nFor this bot I made it possible to track, remove and list your watches by these commands:\n\n- track “from-station” “to-station” from-time till-time - Add a watch for voyage track for any disruptions. Note that and should be surrounded by double-quotes. With time, note that and should be in a 24h format (00:00)\n- remove id - Remove a watch by id\n- list - List all watches and their id (to remove it)\n\nLet’s first define our commands:\n\n```scala\nsealed trait BotCommand\nobject BotCommand {\n  case class TrackVoyage(fromStation: String, toStation: String, fromHour: Time, toHour: Time) extends BotCommand\n  case class RemoveVoyage(id: Int) extends BotCommand\n  case object ListVoyages extends BotCommand\n}\n```\n\nParsing this with Atto is quite simple:\n\n```scala\nobject Parsing {\n  private def fixed(n: Int): Parser[Int] =\n    count(n, digit).map(_.mkString).flatMap { s =>\n      try ok(s.toInt) catch {\n        case e: NumberFormatException => err(e.toString)\n      }\n    }\n\n  private val time = (fixed(2) <~ char(':') |@| fixed(2)) map Time.apply\n  private val station = stringLiteral\n\n  val trackVoyage: Parser[BotCommand.TrackVoyage] =\n    (string(\"track\") ~> (spaceChar ~> station) |@| (spaceChar ~> station) |@| (spaceChar ~> time) |@| (spaceChar ~> time)) map BotCommand.TrackVoyage.apply\n\n  val removeVoyage: Parser[BotCommand.RemoveVoyage] =\n    (string(\"remove\") ~> (spaceChar ~> int)) map BotCommand.RemoveVoyage.apply\n\n  val listVoyages: Parser[BotCommand.ListVoyages.type] =\n    string(\"list\") >| BotCommand.ListVoyages\n}\n```\n\n### Creating handlers\n\nNow we got the parsers we need to create handlers for each command. So what is needed for a command handler?\n\n- We need a parser which extracts the actual command as a case class (we’ve used coded that as a Parser[A])\n- There is a choice between multiple handlers. Whenever the parsing succeeds it should continue with the supplied function (which has the extracted command and performs database queries) and when it fails to parse, it should try the next handler\n- We have branching in our command handling. The entered command might a good one, or one which will fail. We need to verify that by using assertions or database queries. In the end, the format of the result will be the same (A user expects a message what his command did)\n\n#### Partial functions\n\nSo let’s start with the choice between multiple handlers. We can model that with a PartialFunction. The nice thing about PartialFunction is that they are composable. You can combine multiple PartialFunction’s by using `orElse` You can create a partial function by using Function.unlift. The signature looks like: `def unlift[T, R](f: T => Option[R]): PartialFunction[T, R]` which is in the standard Scala library.\n\nSo a quick a example:\n\n```scala\nval a = Function.unlift[String, Int](str => if(str == \"1\") Some(1) else None)\nval b = Function.unlift[String, Int](str => if(str == \"2\") Some(2) else None)\nval c = a orElse b\n\ndef process(i: String) = c.applyOrElse(i, (_: String) => 0)\n\nprocess(\"1\") // will return 1\nprocess(\"3\") // will return 0\n```\n\nThis is, of course, a simple example, but it will work with our little `Parser[A]`. We can feed that a String using parseOnly which will return a `ParseResult[A]` which is convertible to an `Option[A]`. That’s exactly what we need for PartialFunction!\nBranching and running database effects\n\nSo now we get to the part where we need to branch our computations and run database effects. As stated before we are using Doobie for the database. Running a query will return us a `Task[A]` and requires us to have a `transactor.Transactor[Task]` to turn `Query[A]` into `Task[Vector[A]]` for example.\n\nTo have `transactor.Transactor[Task]` available, we can use a type `Prg[A] = ReaderT[F, transactor.Transactor[Task], A]]` for this matter. Where `F[_]` is a `Monad`. You don’t need to pass this `transactor.Transactor[Task]` around when writing a handler, we push this concern to the boundary of our app.\n\nWhenever a query returns not enough results or the entered information is incorrect we need to return an error or continue whenever everything is alright. In other words, branching. We can use `Either[L, R]` to do branching (which is right biased in Scala 2.12 and forms a Monad). However, we need to evaluate the effects of `Task[_]` (`Task[_]` is also a Monad). So we’ll need a `type Prg[A] = EitherT[Task, String, A]` (monad transformer). This also forms a `Monad`, so we can put this into the `F[_]` of `type Prg[A] = ReaderT[F, transactor.Transactor[Task], A]`.\n\nThis will give us a `type Prg[A] => ReaderT[EitherT[Task, String, ?], transactor.Transactor[Task], A]]`. What is this `?` syntax. It is syntax sugar for type lambdas. You can find more info on that on the kind-projector project.\n\nTo actual lift expressions `Option[A]`, `Query[A]` or `Task[A]` to this monad transformer stack I create several combinators that ease the process. I’ve left those out in this article, but you may see them in the final example. In case you are curious, you could check the source code to see their implementation.\n\n## Putting it together\n\nSo how do we put this together? The handle combinator would look something like this:\n\n```scala\ndef handle[A](p: Parser[A])(f: A => ReaderT[EitherT[Task, String, ?], transactor.Transactor[Task], String]]) =\n    Function.unlift[String, ReaderT[Task, transactor.Transactor[Task], String]](x =>\n      p.parseOnly(x).map(y => f(x).mapF(_.fold(identity, identity))).option\n    )\n```\n\nSo let’s break this down. The arguments are\n\n- `p: Parser[A]` is required to extract `A` from a `String`\n- `f: A => ReaderT[EitherT[Task, String, ?], transactor.Transactor[Task], String]]` is the actual handler function. It returns the monad stack as composed before and it consumes the parsed `A`\n\nIn the implementation of the handler combinator, `Function.unlift` will consume String and return a `ReaderT[Task, transactor.Transactor[Task], String]`. First we use the parse the string using `p.parseOnly(x)`. This will return a `ParseResult[A]` which has a map combinator. After that we apply our f function to get a `ReaderT[EitherT[Task, String, ?], transactor.Transactor[Task], String]]`. After that we use `mapF` to remove the disjunction part (`EitherT`) by `_.fold(identity, identity)`. After that we use the `.option` combinator to turn `ParseResult[ReaderT[Task, transactor.Transactor[Task], String]]` into a `Option[ReaderT[Task, transactor.Transactor[Task], String]]`. Remember that we need to return a `Option` for `Function.unlift`. So that concludes the implementation of the handle combinator. Below a example of the usage of handle:\n\n```scala\nval add = handle(Parsing.trackVoyage) { req =>\n  for {\n    _ <- guard(Stations.names.contains(req.fromStation), s\"Station '${req.fromStation}' not found\")\n    _ <- guard(Stations.names.contains(req.toStation), s\"Station '${req.toStation}' not found\")\n    _ <- update(VoyageSubscription(req.fromStation, req.toStation, req.fromHour, req.toHour))(Queries.insertSubscription)\n  } yield \"Added\"\n}\n\nval remove = handle(Parsing.removeVoyage) { req =>\n  for {\n    count <- update0(Queries.removeSubscription(req.id, req.chatId))\n    _ <- guard(count > 0, s\"Failed to removed voyage with id ${req.id}\")\n  } yield \"Removed\"\n}\n\nval list = handle(Parsing.listVoyages) { req =>\n  for {\n    voyages <- listQuery(Queries.listSubscriptions(req.chatId))\n  } yield\n    if (voyages.nonEmpty) BotReply(voyages.map(v => s\"${v.id} | ${v.value.fromStation} ->> ${v.value.toStation}\").mkString(\"\\n\"))\n    else \"You don't have any voyages yet!\"\n}\n\nval handlers = add orElse remove orElse list\n\ndef handleRequest(xa: transactor.Transactor[Task])\n                 (r: String): Task[String] = {\n  val fail = (_: String) => ReaderT[Task, transactor.Transactor[Task], String](_ => Task.now(\"Invalid command\"))\n\n  handlers.applyOrElse(r, fail).run(xa)\n}\n```\n\nAs you can see, it’s very concise to define handlers. Like I said before I’ve defined monad transformer combinators like `guard`, `update`, `update0`, `listQuery`, etc for validating, retrieving and update/inserting data (you can see their implementation at the repository).\n\nSo to recap, how did we design this pipeline?\n\n- We split up our problems in small steps\n- For each step, we evaluate which solutions we could apply (by experimenting or consulting our functional programming tools)\n- We model our side-effects and branching explicitly\n- We push side-effects to the boundary of the program\n\n# Stream processing with fs2\n\nAs stated before we have two processes in our program. One for handling HTTP requests and one for pulling the database from time to time and check if there any disruptions for the interested watchers. I’ll show and explain the latter.\n\nThis is the code for pulling the database and notify the watcher in case of disruption:\n\n```scala\n//a `Task[_]` which sends a telegram message and stores that we've notified the user in the database\ndef notify(sub: Entity[VoyageSubscription], delayedVoyage: Voyage): Task[Int] = ???\n\nval notifier: Stream[Task, Unit] = for {\n  _ <- fs2.time.awakeEvery(60.seconds)\n  voyageSubscription <- Queries.uniqueSubscribedStations.process.transact(xa)\n  voyages <- Stream.eval(NsApi.voyages(voyageSubscription.fromStation).run(cfg.ns))\n  delayedVoyage <- Stream.emits(voyages.filter(x => x.delay.nonEmpty || x.comments.exists(_.contains(\"Rijdt niet\"))))\n  sub <- Queries.subscriptions(voyageSubscription.subscriptionIds, delayedVoyage.ritNr).process.transact(xa)\n  _ <- if(delayedVoyage.destinations.contains(sub.value.toStation)) Stream.eval(notify(sub, delayedVoyage)) else Stream.emit(())\n} yield ()\n```\n\nWe can build up a Stream[F, A] by using a for-comprehension. This is because Stream is also a Monad.\n\n- `_ <- fs2.time.awakeEvery(60.seconds)` - will sleep the stream for 60 seconds\n- `voyageSubscription <- Queries.uniqueSubscribedStations.process.transact(xa)` - Will retrieve all stations which are been watched by the users. `.process` will turn this `Query[VoyageSubscriptions]` into `Stream[Task, VoyageSubscriptions]`\n- `voyages <- Stream.eval(NsApi.voyages(voyageSubscription.fromStation).run(cfg.ns))` - Will call the NS API and retrieve a `List[Voyage]`. The combinator `Stream.eval` will evaluate a `Task[A]` and put it into the `Stream[Task, A]`\n- `delayedVoyage <- Stream.emits(voyages.filter(x => x.delay.nonEmpty || x.comments.exists(_.contains(\"Rijdt niet\"))))` - Will only filter delayed voyages. After that we use Stream.emits to emit a `Seq[A]` to a `Stream[Task, A]`\n- `sub <- Queries.subscriptions(voyageSubscription.subscriptionIds, delayedVoyage.ritNr).process.transact(xa)` - Will retrieve a list of watches which are not notified yet. Note that we use `.process` again to retrieve a query as a `Stream[Task, A]`.\n- `_ <- if(delayedVoyage.destinations.contains(sub.value.toStation)) Stream.eval(notify(sub, delayedVoyage)) else Stream.emit(())` - Will check if `delayedVoyage.destinations` contains the target station of the watcher. If so, we’ll notify otherwise we just continue.\n\nAs you can see it’s very easily building a pull-based stream processor by using fs2 and doobie.\n\n# Conclusion and future work\n\nI liked writing code in the functional style in Scala. We explicitly capture side effects, push the effects to the outside of the program, pull-based stream processing, easy configuration, and excellent JSON encoding/decoding. The quality of these functional libraries is excellent.\n\nThe work on this bot is not complete. It needs circuit breakers, setting up a watch can be conversational, etc.\n";
				}
				function compiledContent() {
					return html;
				}
				function getHeadings() {
					return [{"depth":2,"slug":"knowledge-prerequisites","text":"Knowledge prerequisites"},{"depth":2,"slug":"the-stack","text":"The stack"},{"depth":2,"slug":"telegram","text":"Telegram"},{"depth":3,"slug":"creating-a-bot-and-get-your-botid","text":"Creating a bot and get your botId"},{"depth":3,"slug":"register-your-server","text":"Register your server"},{"depth":3,"slug":"send-a-message-back","text":"Send a message back"},{"depth":2,"slug":"high-level-architecture","text":"High-level architecture"},{"depth":2,"slug":"telegram-command-to-reply-pipeline","text":"Telegram command to reply pipeline"},{"depth":3,"slug":"parsing","text":"Parsing"},{"depth":3,"slug":"creating-handlers","text":"Creating handlers"},{"depth":4,"slug":"partial-functions","text":"Partial functions"},{"depth":2,"slug":"putting-it-together","text":"Putting it together"},{"depth":1,"slug":"stream-processing-with-fs2","text":"Stream processing with fs2"},{"depth":1,"slug":"conclusion-and-future-work","text":"Conclusion and future work"}];
				}
				async function Content() {
					const { layout, ...content } = frontmatter;
					content.file = file;
					content.url = url;
					const contentFragment = createVNode(Fragment, { 'set:html': html });
					return contentFragment;
				}
				Content[Symbol.for('astro.needsHeadRendering')] = true;

export { Content, compiledContent, Content as default, file, frontmatter, getHeadings, images, rawContent, url };
